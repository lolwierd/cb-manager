<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CBManager — Architecture Overview</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  /* ============ THEME — DARK-FIRST (Catppuccin-inspired) ============ */
  :root {
    --font-body: 'Sora', system-ui, sans-serif;
    --font-mono: 'IBM Plex Mono', 'SF Mono', Consolas, monospace;

    --bg: #11111b;
    --surface: #181825;
    --surface2: #1e1e2e;
    --surface-elevated: #24243e;
    --border: rgba(255, 255, 255, 0.06);
    --border-bright: rgba(255, 255, 255, 0.14);
    --text: #cdd6f4;
    --text-dim: #6c7086;

    --blue: #89b4fa;
    --blue-dim: rgba(137, 180, 250, 0.12);
    --mauve: #cba6f7;
    --mauve-dim: rgba(203, 166, 247, 0.10);
    --green: #a6e3a1;
    --green-dim: rgba(166, 227, 161, 0.10);
    --peach: #fab387;
    --peach-dim: rgba(250, 179, 135, 0.10);
    --teal: #94e2d5;
    --teal-dim: rgba(148, 226, 213, 0.10);
    --red: #f38ba8;
    --red-dim: rgba(243, 139, 168, 0.10);
    --yellow: #f9e2af;
    --yellow-dim: rgba(249, 226, 175, 0.10);
    --lavender: #b4befe;
    --lavender-dim: rgba(180, 190, 254, 0.10);
    --flamingo: #f2cdcd;
    --flamingo-dim: rgba(242, 205, 205, 0.10);
  }

  @media (prefers-color-scheme: light) {
    :root {
      --bg: #eff1f5;
      --surface: #ffffff;
      --surface2: #e6e9ef;
      --surface-elevated: #ffffff;
      --border: rgba(0, 0, 0, 0.07);
      --border-bright: rgba(0, 0, 0, 0.15);
      --text: #1e1e2e;
      --text-dim: #7c7f93;

      --blue: #1e66f5;
      --blue-dim: rgba(30, 102, 245, 0.08);
      --mauve: #8839ef;
      --mauve-dim: rgba(136, 57, 239, 0.08);
      --green: #40a02b;
      --green-dim: rgba(64, 160, 43, 0.08);
      --peach: #fe640b;
      --peach-dim: rgba(254, 100, 11, 0.08);
      --teal: #179299;
      --teal-dim: rgba(23, 146, 153, 0.08);
      --red: #d20f39;
      --red-dim: rgba(210, 15, 57, 0.08);
      --yellow: #df8e1d;
      --yellow-dim: rgba(223, 142, 29, 0.08);
      --lavender: #7287fd;
      --lavender-dim: rgba(114, 135, 253, 0.08);
      --flamingo: #dd7878;
      --flamingo-dim: rgba(221, 120, 120, 0.08);
    }
  }

  /* ============ RESET + BASE ============ */
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    background-image:
      radial-gradient(ellipse at 15% 5%, var(--mauve-dim) 0%, transparent 45%),
      radial-gradient(ellipse at 85% 90%, var(--teal-dim) 0%, transparent 40%);
    color: var(--text);
    font-family: var(--font-body);
    padding: 40px;
    min-height: 100vh;
    overflow-wrap: break-word;
  }

  /* ============ ANIMATION ============ */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(14px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes fadeScale {
    from { opacity: 0; transform: scale(0.92); }
    to { opacity: 1; transform: scale(1); }
  }

  .section, .flow-arrow, .kpi-card { animation: fadeUp 0.45s ease-out both; animation-delay: calc(var(--i, 0) * 0.06s); }
  .kpi-card { animation-name: fadeScale; }

  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after { animation-duration: 0.01ms !important; animation-delay: 0ms !important; transition-duration: 0.01ms !important; }
  }

  /* ============ NAV LAYOUT ============ */
  .wrap {
    max-width: 1400px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 180px 1fr;
    gap: 0 40px;
  }
  .main { min-width: 0; }

  /* TOC */
  .toc {
    position: sticky;
    top: 24px;
    align-self: start;
    padding: 14px 0;
    grid-row: 1 / -1;
    max-height: calc(100dvh - 48px);
    overflow-y: auto;
  }
  .toc::-webkit-scrollbar { width: 3px; }
  .toc::-webkit-scrollbar-thumb { background: var(--surface-elevated); border-radius: 2px; }

  .toc-title {
    font-family: var(--font-mono);
    font-size: 9px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--text-dim);
    padding: 0 0 10px;
    margin-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }

  .toc a {
    display: block;
    font-size: 11px;
    color: var(--text-dim);
    text-decoration: none;
    padding: 4px 8px;
    border-radius: 5px;
    border-left: 2px solid transparent;
    transition: all 0.15s;
    line-height: 1.4;
    margin-bottom: 1px;
  }
  .toc a:hover { color: var(--text); background: var(--surface2); }
  .toc a.active { color: var(--text); border-left-color: var(--blue); }

  @media (max-width: 1000px) {
    .wrap { grid-template-columns: 1fr; padding-top: 0; }
    body { padding-top: 0; }
    .toc {
      position: sticky; top: 0; z-index: 200;
      max-height: none; display: flex; gap: 4px; align-items: center;
      overflow-x: auto; -webkit-overflow-scrolling: touch;
      background: var(--bg); border-bottom: 1px solid var(--border);
      padding: 10px 0; margin: 0 -40px; padding-left: 40px; padding-right: 40px;
      grid-row: auto;
    }
    .toc::-webkit-scrollbar { display: none; }
    .toc-title { display: none; }
    .toc a { white-space: nowrap; flex-shrink: 0; border-left: none; border-bottom: 2px solid transparent; border-radius: 4px 4px 0 0; padding: 6px 10px; font-size: 10px; }
    .toc a.active { border-left: none; border-bottom-color: var(--blue); background: var(--surface); }
    .main { padding-top: 20px; }
    .sec-head { scroll-margin-top: 52px; }
  }

  /* ============ TYPOGRAPHY ============ */
  h1 {
    font-size: 40px;
    font-weight: 700;
    letter-spacing: -1.5px;
    margin-bottom: 6px;
    background: linear-gradient(135deg, var(--blue) 0%, var(--mauve) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .subtitle { color: var(--text-dim); font-size: 13px; margin-bottom: 36px; font-family: var(--font-mono); }

  .sec-head {
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-top: 48px;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .sec-head .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }

  /* ============ DIAGRAM CONTAINER ============ */
  .diagram { display: grid; grid-template-columns: 1fr; gap: 20px; max-width: 1100px; }

  /* ============ SECTION CARD ============ */
  .section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px 24px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .section:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(0,0,0,0.1); }

  .section--hero {
    background: var(--surface-elevated);
    border-color: color-mix(in srgb, var(--border) 50%, var(--blue) 50%);
    box-shadow: 0 4px 24px rgba(0,0,0,0.08);
    padding: 28px 32px;
  }

  .section--recessed { background: var(--surface2); box-shadow: inset 0 1px 3px rgba(0,0,0,0.06); }

  .section-label {
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .section-label .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }

  /* Color variants */
  .c-blue { color: var(--blue); } .b-blue { border-color: var(--blue-dim); }
  .c-mauve { color: var(--mauve); } .b-mauve { border-color: var(--mauve-dim); }
  .c-green { color: var(--green); } .b-green { border-color: var(--green-dim); }
  .c-peach { color: var(--peach); } .b-peach { border-color: var(--peach-dim); }
  .c-teal { color: var(--teal); } .b-teal { border-color: var(--teal-dim); }
  .c-red { color: var(--red); } .b-red { border-color: var(--red-dim); }
  .c-yellow { color: var(--yellow); } .b-yellow { border-color: var(--yellow-dim); }
  .c-lav { color: var(--lavender); } .b-lav { border-color: var(--lavender-dim); }
  .c-flam { color: var(--flamingo); } .b-flam { border-color: var(--flamingo-dim); }

  .bg-blue { background: var(--blue); } .bg-mauve { background: var(--mauve); }
  .bg-green { background: var(--green); } .bg-peach { background: var(--peach); }
  .bg-teal { background: var(--teal); } .bg-red { background: var(--red); }
  .bg-yellow { background: var(--yellow); } .bg-lav { background: var(--lavender); }
  .bg-flam { background: var(--flamingo); }

  /* ============ INNER GRID ============ */
  .inner-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .inner-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

  .inner-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
  }
  .inner-card .title { font-weight: 600; font-size: 13px; margin-bottom: 4px; }
  .inner-card .desc { color: var(--text-dim); font-size: 12px; line-height: 1.6; }
  .inner-card code {
    font-family: var(--font-mono);
    font-size: 11px;
    padding: 1px 5px;
    border-radius: 3px;
  }

  /* ============ FLOW ARROW ============ */
  .flow-arrow {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    color: var(--text-dim);
    font-family: var(--font-mono);
    font-size: 12px;
    padding: 2px 0;
  }
  .flow-arrow svg { width: 20px; height: 20px; fill: none; stroke: var(--border-bright); stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

  /* ============ PIPELINE ============ */
  .pipeline { display: flex; gap: 0; align-items: stretch; overflow-x: auto; padding-bottom: 4px; }
  .pipeline-step {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 14px;
    min-width: 130px;
    flex-shrink: 0;
    text-align: center;
  }
  .pipeline-step .step-num { font-family: var(--font-mono); font-size: 10px; font-weight: 600; margin-bottom: 4px; }
  .pipeline-step .step-name { font-size: 12px; font-weight: 600; margin-bottom: 3px; }
  .pipeline-step .step-detail { font-size: 10px; color: var(--text-dim); line-height: 1.5; }
  .pipeline-arrow { display: flex; align-items: center; padding: 0 3px; color: var(--border-bright); font-size: 16px; flex-shrink: 0; }
  .pipeline-parallel { display: flex; flex-direction: column; gap: 4px; }

  /* ============ LISTS ============ */
  .node-list { list-style: none; font-size: 12px; line-height: 1.9; }
  .node-list li { padding-left: 14px; position: relative; min-width: 0; }
  .node-list li::before { content: '›'; color: var(--text-dim); font-weight: 600; position: absolute; left: 0; }
  .node-list code {
    font-family: var(--font-mono);
    font-size: 11px;
    padding: 1px 5px;
    border-radius: 3px;
  }

  /* ============ KPI ROW ============ */
  .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 14px; }
  .kpi-card {
    background: var(--surface-elevated);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 18px;
    text-align: center;
  }
  .kpi-card__value { font-size: 28px; font-weight: 700; letter-spacing: -1px; line-height: 1.1; }
  .kpi-card__label { font-family: var(--font-mono); font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-dim); margin-top: 6px; }

  /* ============ THREE COL ============ */
  .three-col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; }

  /* ============ CALLOUT ============ */
  .callout {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-left: 3px solid var(--blue);
    border-radius: 0 8px 8px 0;
    padding: 14px 18px;
    font-size: 13px;
    line-height: 1.6;
    color: var(--text-dim);
  }
  .callout strong { color: var(--text); font-weight: 600; }
  .callout code { font-family: var(--font-mono); font-size: 11px; background: var(--blue-dim); color: var(--blue); padding: 1px 5px; border-radius: 3px; }

  /* ============ TAG ============ */
  .tag { font-family: var(--font-mono); font-size: 10px; font-weight: 500; padding: 2px 7px; border-radius: 4px; white-space: nowrap; }

  /* ============ COLLAPSIBLE ============ */
  details.collapsible { border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
  details.collapsible summary {
    padding: 14px 20px; background: var(--surface); font-family: var(--font-mono); font-size: 12px; font-weight: 600;
    cursor: pointer; list-style: none; display: flex; align-items: center; gap: 8px; color: var(--text); transition: background 0.15s ease;
  }
  details.collapsible summary:hover { background: var(--surface-elevated); }
  details.collapsible summary::-webkit-details-marker { display: none; }
  details.collapsible summary::before { content: '▸'; font-size: 11px; color: var(--text-dim); transition: transform 0.15s ease; }
  details.collapsible[open] summary::before { transform: rotate(90deg); }
  details.collapsible .collapsible__body { padding: 16px 20px; border-top: 1px solid var(--border); font-size: 13px; line-height: 1.6; }

  /* ============ SOURCES ROW ============ */
  .sources { display: flex; gap: 12px; flex-wrap: wrap; }
  .source {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 8px;
    padding: 10px 18px; font-family: var(--font-mono); font-size: 13px; font-weight: 500;
    display: flex; align-items: center; gap: 8px; transition: border-color 0.2s;
  }
  .source:hover { border-color: var(--border-bright); }

  /* ============ MERMAID ============ */
  .mermaid-wrap {
    position: relative;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 32px 24px;
    overflow: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }
  .mermaid-wrap::-webkit-scrollbar { width: 6px; height: 6px; }
  .mermaid-wrap::-webkit-scrollbar-track { background: transparent; }
  .mermaid-wrap::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .mermaid-wrap .mermaid { transition: transform 0.2s ease; transform-origin: top center; }

  .zoom-controls {
    position: absolute; top: 8px; right: 8px; display: flex; gap: 2px; z-index: 10;
    background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 2px;
  }
  .zoom-controls button {
    width: 28px; height: 28px; border: none; background: transparent; color: var(--text-dim);
    font-family: var(--font-mono); font-size: 14px; cursor: pointer; border-radius: 4px;
    display: flex; align-items: center; justify-content: center; transition: background 0.15s ease, color 0.15s ease;
  }
  .zoom-controls button:hover { background: var(--border); color: var(--text); }
  .mermaid-wrap.is-zoomed { cursor: grab; }
  .mermaid-wrap.is-panning { cursor: grabbing; user-select: none; }

  .mermaid .nodeLabel { color: var(--text) !important; }
  .mermaid .edgeLabel { color: var(--text-dim) !important; background-color: var(--bg) !important; }
  .mermaid .edgeLabel rect { fill: var(--bg) !important; }
  .mermaid .node rect, .mermaid .node circle, .mermaid .node polygon { stroke-width: 1.5px; }
  .mermaid .edge-pattern-solid { stroke-width: 1.5px; }
  .mermaid .edgeLabel { font-family: var(--font-mono) !important; font-size: 12px !important; }
  .mermaid .nodeLabel { font-family: var(--font-body) !important; font-size: 14px !important; }

  /* ============ RESPONSIVE ============ */
  @media (max-width: 768px) {
    body { padding: 16px; }
    .inner-grid, .inner-grid-3 { grid-template-columns: 1fr; }
    .three-col { grid-template-columns: 1fr; }
    .pipeline { flex-wrap: wrap; gap: 6px; }
    .pipeline-arrow { display: none; }
    h1 { font-size: 28px; }
  }

  /* code color helpers */
  code.cb { background: var(--blue-dim); color: var(--blue); }
  code.cm { background: var(--mauve-dim); color: var(--mauve); }
  code.cg { background: var(--green-dim); color: var(--green); }
  code.cp { background: var(--peach-dim); color: var(--peach); }
  code.ct { background: var(--teal-dim); color: var(--teal); }
  code.cr { background: var(--red-dim); color: var(--red); }
  code.cy { background: var(--yellow-dim); color: var(--yellow); }
  code.cl { background: var(--lavender-dim); color: var(--lavender); }
</style>
</head>
<body>

<div class="wrap">

<nav class="toc" id="toc">
  <div class="toc-title">Contents</div>
  <a href="#s0">Overview</a>
  <a href="#s1">1. High-Level Architecture</a>
  <a href="#s2">2. Core Loop</a>
  <a href="#s3">3. Search Pipeline</a>
  <a href="#s4">4. Paste Flow</a>
  <a href="#s5">5. Image Processing</a>
  <a href="#s6">6. Data Layer</a>
  <a href="#s7">7. Window &amp; Panel System</a>
  <a href="#s8">8. Key Decisions</a>
  <a href="#s9">9. File Map</a>
  <a href="#s10">10. Dependencies</a>
</nav>

<div class="main">

<h1>CBManager Architecture</h1>
<p class="subtitle">macOS menu bar clipboard manager &mdash; Swift + SwiftUI + AppKit &mdash; macOS 26+</p>

<!-- ========== KPI OVERVIEW ========== -->
<div id="s0" class="sec-head" style="--i:0"><span class="dot bg-blue"></span><span class="c-blue">Overview</span></div>

<div class="kpi-row" style="margin-bottom: 24px;">
  <div class="kpi-card" style="--i:1"><div class="kpi-card__value c-blue">20</div><div class="kpi-card__label">Swift Files</div></div>
  <div class="kpi-card" style="--i:2"><div class="kpi-card__value c-mauve">5</div><div class="kpi-card__label">Entry Types</div></div>
  <div class="kpi-card" style="--i:3"><div class="kpi-card__value c-green">3</div><div class="kpi-card__label">Search Engines</div></div>
  <div class="kpi-card" style="--i:4"><div class="kpi-card__value c-peach">0</div><div class="kpi-card__label">External Swift Deps</div></div>
  <div class="kpi-card" style="--i:5"><div class="kpi-card__value c-teal">∞</div><div class="kpi-card__label">Entry Limit</div></div>
</div>

<div class="section section--hero b-blue" style="--i:6">
  <div class="section-label c-blue"><span class="dot bg-blue"></span>What Is CBManager?</div>
  <p style="font-size: 14px; line-height: 1.7; color: var(--text-dim);">
    A <strong style="color: var(--text)">native macOS menu bar utility</strong> that silently captures your clipboard history — text, links, code, paths, and images — and presents a
    <strong style="color: var(--text)">Spotlight-style overlay</strong> (default <code class="cb">⌘⇧V</code>) for instant fuzzy search, optionally augmented by <strong style="color: var(--text)">QMD keyword &amp; semantic search</strong>.
    Select an entry and it pastes directly into whatever app you were in. Zero external Swift dependencies — only system frameworks + optional <code class="ct">qmd</code> CLI.
  </p>
</div>

<!-- ========== 1. HIGH-LEVEL ARCHITECTURE ========== -->
<div id="s1" class="sec-head" style="--i:7"><span class="dot bg-mauve"></span><span class="c-mauve">1 &mdash; High-Level Architecture</span></div>

<div class="mermaid-wrap section" style="--i:8">
  <div class="zoom-controls">
    <button onclick="zoomDiagram(this, 1.2)" title="Zoom in">+</button>
    <button onclick="zoomDiagram(this, 0.8)" title="Zoom out">&minus;</button>
    <button onclick="resetZoom(this)" title="Reset zoom">&#8634;</button>
  </div>
  <pre class="mermaid">
graph TD
  subgraph MenuBar["Menu Bar"]
    SBC["StatusBarController"]
  end

  subgraph Hotkey["Global Hotkey"]
    GHK["GlobalHotKey (Carbon)"]
    HKS["HotKeyShortcut"]
  end

  subgraph Coordinator["App Coordinator"]
    AM["AppModel"]
  end

  subgraph Overlay["Overlay System"]
    OPC["OverlayPanelController"]
    FP["FocusPanel (NSPanel)"]
    SOV["SearchOverlayView (SwiftUI)"]
    EPPC["EntryPreviewPanelController"]
    AGC["AlignmentGuidesController"]
  end

  subgraph DataLayer["Data Layer"]
    CS["ClipboardStore"]
    CDB["ClipboardDatabase (SQLite)"]
    CSR["ClipboardSearch"]
    QMD["QMDSearchEngine"]
  end

  subgraph ImagePipeline["Image Pipeline"]
    ITR["ImageTextRecognizer (Vision OCR)"]
    ITG["ImageTitleGenerator (pi CLI)"]
    TC["ThumbnailCache (ImageIO)"]
  end

  subgraph Settings["Settings"]
    SPC["SettingsPanelController"]
    SRPC["ShortcutRecorderPanelController"]
    SV["SettingsView"]
  end

  SBC -->|"left click: toggle"| AM
  SBC -->|"right click: menu"| AM
  GHK -->|"onPressed"| AM
  HKS --> GHK

  AM -->|"owns"| CS
  AM -->|"toggle/show"| OPC
  AM -->|"settings"| SPC
  AM -->|"shortcut record"| SRPC

  OPC -->|"hosts"| FP
  FP -->|"contentView"| SOV
  OPC -->|"preview"| EPPC
  OPC -->|"snap guides"| AGC
  SOV -->|"reads"| CS

  CS -->|"CRUD"| CDB
  CS -->|"rank"| CSR
  CS -->|"keyword + semantic"| QMD
  CS -->|"OCR"| ITR
  CS -->|"AI titles"| ITG

  SOV -->|"thumbnail"| TC

  SPC -->|"hosts"| SV

  classDef coordCls fill:#cba6f722,stroke:#cba6f7,stroke-width:2px
  classDef overlayCls fill:#89b4fa22,stroke:#89b4fa,stroke-width:1.5px
  classDef dataCls fill:#a6e3a122,stroke:#a6e3a1,stroke-width:1.5px
  classDef imageCls fill:#fab38722,stroke:#fab387,stroke-width:1.5px
  classDef settingsCls fill:#f9e2af22,stroke:#f9e2af,stroke-width:1.5px
  classDef hotkeyCls fill:#f38ba822,stroke:#f38ba8,stroke-width:1.5px
  classDef menuCls fill:#94e2d522,stroke:#94e2d5,stroke-width:1.5px

  class AM coordCls
  class SBC menuCls
  class GHK,HKS hotkeyCls
  class OPC,FP,SOV,EPPC,AGC overlayCls
  class CS,CDB,CSR,QMD dataCls
  class ITR,ITG,TC imageCls
  class SPC,SRPC,SV settingsCls
  </pre>
</div>

<!-- ========== 2. CORE LOOP ========== -->
<div id="s2" class="sec-head" style="--i:9"><span class="dot bg-green"></span><span class="c-green">2 &mdash; Core Capture Loop</span></div>

<div class="diagram">
  <div class="section section--hero b-green" style="--i:10">
    <div class="section-label c-green"><span class="dot bg-green"></span>Clipboard Monitoring</div>
    <p style="font-size: 13px; color: var(--text-dim); line-height: 1.7; margin-bottom: 16px;">
      <code class="cg">ClipboardStore</code> polls <code class="cg">NSPasteboard.general</code> every <strong style="color: var(--text)">150ms</strong> via a repeating <code class="cg">Timer</code> on <code class="cg">RunLoop.main</code>.
      When <code class="cg">changeCount</code> differs from the last seen value, it captures the new content. This approach avoids private APIs and works reliably with all macOS apps.
    </p>

    <div class="pipeline">
      <div class="pipeline-step" style="border-color: var(--teal-dim);">
        <div class="step-num c-teal">1</div>
        <div class="step-name">Poll</div>
        <div class="step-detail">Check changeCount<br>every 150ms</div>
      </div>
      <div class="pipeline-arrow">→</div>
      <div class="pipeline-step" style="border-color: var(--blue-dim);">
        <div class="step-num c-blue">2</div>
        <div class="step-name">Capture</div>
        <div class="step-detail">String → Text/Link/<br>Code/Path<br>Image → PNG file</div>
      </div>
      <div class="pipeline-arrow">→</div>
      <div class="pipeline-step" style="border-color: var(--mauve-dim);">
        <div class="step-num c-mauve">3</div>
        <div class="step-name">Classify</div>
        <div class="step-detail">Heuristic-based<br>kind detection</div>
      </div>
      <div class="pipeline-arrow">→</div>
      <div class="pipeline-step" style="border-color: var(--peach-dim);">
        <div class="step-num c-peach">4</div>
        <div class="step-name">Dedup</div>
        <div class="step-detail">Compare to latest<br>entry (byte-level<br>for images)</div>
      </div>
      <div class="pipeline-arrow">→</div>
      <div class="pipeline-step" style="border-color: var(--green-dim);">
        <div class="step-num c-green">5</div>
        <div class="step-name">Store</div>
        <div class="step-detail">In-memory array<br>+ SQLite + QMD doc</div>
      </div>
      <div class="pipeline-arrow">→</div>
      <div class="pipeline-parallel">
        <div class="pipeline-step" style="border-color: var(--yellow-dim);">
          <div class="step-num c-yellow">6a</div>
          <div class="step-name">OCR</div>
          <div class="step-detail">Vision framework<br>(images only)</div>
        </div>
        <div class="pipeline-step" style="border-color: var(--flamingo-dim);">
          <div class="step-num c-flam">6b</div>
          <div class="step-name">AI Title</div>
          <div class="step-detail">pi CLI<br>(images only)</div>
        </div>
      </div>
    </div>
  </div>

  <div class="callout section section--recessed" style="--i:11; border-left-color: var(--green);">
    <strong>Content classification</strong> — The <code class="cg">classify()</code> function uses simple heuristics:
    URLs starting with <code class="cg">http/https</code> → <strong>Link</strong>,
    paths starting with <code class="cg">/</code> or <code class="cg">~/</code> → <strong>Path</strong>,
    presence of code markers (<code class="cg">{</code>, <code class="cg">import</code>, <code class="cg">func</code>, <code class="cg">SELECT</code>, etc.) → <strong>Code</strong>,
    everything else → <strong>Text</strong>.
    Images are detected via <code class="cg">NSImage(pasteboard:)</code> and saved as PNG to the images directory.
  </div>
</div>

<!-- ========== 3. SEARCH PIPELINE ========== -->
<div id="s3" class="sec-head" style="--i:12"><span class="dot bg-blue"></span><span class="c-blue">3 &mdash; Search Pipeline</span></div>

<div class="diagram">
  <div class="section b-blue" style="--i:13">
    <div class="section-label c-blue"><span class="dot bg-blue"></span>Three-Engine Search Merge</div>
    <p style="font-size: 13px; color: var(--text-dim); line-height: 1.7; margin-bottom: 16px;">
      Every keystroke triggers an instant local fuzzy search. When the query is long enough, QMD keyword and semantic searches run asynchronously and their results are <strong style="color: var(--text)">merged below</strong> the fuzzy results — never blocking the UI.
    </p>

    <div class="inner-grid-3">
      <div class="inner-card" style="border-color: var(--green-dim);">
        <div class="title" style="color: var(--green);">① Fuzzy Search</div>
        <div class="desc">
          Runs <strong>instantly</strong> on every keystroke. Multi-token substring + subsequence matching against <code class="cg">searchableText</code> (content + OCR + AI title + source app + kind + search hints).
          Scored by position and gap penalty. Always the primary result set.
        </div>
      </div>
      <div class="inner-card" style="border-color: var(--blue-dim);">
        <div class="title" style="color: var(--blue);">② QMD Keyword</div>
        <div class="desc">
          Fires after <strong>400ms</strong> debounce when query ≥ 3 chars. Runs <code class="cb">qmd search</code> against the document collection. Returns entry IDs that are appended after fuzzy results (deduped).
        </div>
      </div>
      <div class="inner-card" style="border-color: var(--mauve-dim);">
        <div class="title" style="color: var(--mauve);">③ QMD Semantic</div>
        <div class="desc">
          Fires after <strong>1200ms</strong> debounce when query ≥ 5 chars. Runs <code class="cm">qmd vsearch</code> (vector similarity). Catches conceptually related entries that don't share literal text with the query.
        </div>
      </div>
    </div>
  </div>

  <div class="flow-arrow" style="--i:14">
    <svg viewBox="0 0 20 20"><path d="M10 4 L10 16 M6 12 L10 16 L14 12"/></svg>
    merge strategy
  </div>

  <div class="section section--recessed b-blue" style="--i:15">
    <div class="section-label c-blue"><span class="dot bg-blue"></span>Ranking &amp; Merge (<code class="cb">ClipboardSearch.rank()</code>)</div>
    <ul class="node-list">
      <li>Apply <strong>kind filter</strong> (All / Text / Link / Code / Path / Image)</li>
      <li><strong>Fuzzy-scored entries</strong> come first, sorted by score (ties broken by recency)</li>
      <li><strong>QMD-only entries</strong> (keyword ∪ semantic, not in fuzzy set) appended after, sorted by date</li>
      <li>Fuzzy scoring: <strong>exact substring = 250 + position bonus</strong>, subsequence = <strong>140 − gap penalty</strong>, images get +15 bonus</li>
      <li>All tokens must match (AND logic) — if any token fails, the entry is excluded from fuzzy results</li>
    </ul>
  </div>
</div>

<!-- ========== 4. PASTE FLOW ========== -->
<div id="s4" class="sec-head" style="--i:16"><span class="dot bg-peach"></span><span class="c-peach">4 &mdash; Paste &amp; Focus Flow</span></div>

<div class="mermaid-wrap section" style="--i:17">
  <div class="zoom-controls">
    <button onclick="zoomDiagram(this, 1.2)" title="Zoom in">+</button>
    <button onclick="zoomDiagram(this, 0.8)" title="Zoom out">&minus;</button>
    <button onclick="resetZoom(this)" title="Reset zoom">&#8634;</button>
  </div>
  <pre class="mermaid">
sequenceDiagram
  participant U as User
  participant O as Overlay Panel
  participant CS as ClipboardStore
  participant P as NSPasteboard
  participant T as Target App

  U->>O: Press Return on selected entry
  O->>CS: copyToClipboard(entry)
  CS->>P: clearContents + setString/writeObjects
  O->>O: hide(restoreFocus: false)
  Note over O: Wait 80ms
  O->>T: activate(options: [])
  Note over O: Wait 120ms
  O->>T: Synthetic ⌘V via CGEvent
  Note over T: Content pasted!
  </pre>
</div>

<div class="callout section section--recessed" style="--i:18; border-left-color: var(--peach);">
  <strong>Focus restoration</strong> — When the overlay opens, it captures <code class="cp">NSWorkspace.shared.frontmostApplication</code>
  (excluding itself). On close or paste, it reactivates that app. If <code class="cp">activate()</code> fails (app was already hidden),
  it falls back to <code class="cp">NSApp.hide(nil)</code>. The 80ms + 120ms delays give macOS time to complete the app switch before
  injecting the synthetic <code class="cp">⌘V</code> keystroke via <code class="cp">CGEvent</code>.
</div>

<!-- ========== 5. IMAGE PROCESSING ========== -->
<div id="s5" class="sec-head" style="--i:19"><span class="dot bg-yellow"></span><span class="c-yellow">5 &mdash; Image Processing Pipeline</span></div>

<div class="diagram">
  <div class="section b-yellow" style="--i:20">
    <div class="section-label c-yellow"><span class="dot bg-yellow"></span>Image Capture → OCR → AI Title</div>
    <div class="inner-grid">
      <div class="inner-card" style="border-color: var(--yellow-dim);">
        <div class="title" style="color: var(--yellow);">Vision OCR</div>
        <div class="desc">
          <code class="cy">ImageTextRecognizer</code> uses Apple's <strong>VNRecognizeTextRequest</strong> with
          <code class="cy">.accurate</code> recognition level and language correction enabled.
          Runs on <code class="cy">Task.detached(priority: .utility)</code>.
          Extracted text is stored as <code class="cy">ocrText</code> and becomes part of the searchable text index.
        </div>
      </div>
      <div class="inner-card" style="border-color: var(--flamingo-dim);">
        <div class="title" style="color: var(--flamingo);">AI Title Generation</div>
        <div class="desc">
          <code class="cr">ImageTitleGenerator</code> invokes the <strong>pi CLI</strong> with the image attached
          (<code class="cr">@imagePath</code>) to generate a short descriptive title. Uses model
          <code class="cr">gpt-5.1-codex-mini</code> by default (configurable).
          12-second timeout with task cancellation support. Title shows as the list row title for image entries.
        </div>
      </div>
    </div>
  </div>

  <div class="section b-teal" style="--i:21">
    <div class="section-label c-teal"><span class="dot bg-teal"></span>ThumbnailCache</div>
    <p style="font-size: 13px; color: var(--text-dim); line-height: 1.7;">
      Uses <code class="ct">CGImageSourceCreateThumbnailAtIndex</code> to generate 120px thumbnails
      <strong style="color: var(--text)">without decoding the full image</strong>. Backed by <code class="ct">NSCache</code> (limit: 300 entries).
      Also provides <code class="ct">imageDimensions(at:)</code> by reading only the file header via ImageIO properties — no full decode needed.
    </p>
  </div>
</div>

<!-- ========== 6. DATA LAYER ========== -->
<div id="s6" class="sec-head" style="--i:22"><span class="dot bg-green"></span><span class="c-green">6 &mdash; Data Layer</span></div>

<div class="diagram">
  <div class="three-col">
    <div class="section b-green" style="--i:23">
      <div class="section-label c-green"><span class="dot bg-green"></span>In-Memory</div>
      <ul class="node-list">
        <li><code class="cg">ClipboardStore.entries</code> — <code class="cg">@Published</code> array</li>
        <li>Unlimited entries (no hard cap)</li>
        <li>Use auto-prune setting to manage by age</li>
        <li>Undo stack: 20s window, LIFO</li>
        <li>Drives SwiftUI view updates</li>
      </ul>
    </div>
    <div class="section b-blue" style="--i:24">
      <div class="section-label c-blue"><span class="dot bg-blue"></span>SQLite</div>
      <ul class="node-list">
        <li><code class="cb">clipboard.sqlite</code></li>
        <li>Schema: <code class="cb">clipboard_entries</code> table</li>
        <li>Columns: id, created_at, source_app, kind, content, image_path, ocr_text, ocr_pending, ai_title, ai_title_pending</li>
        <li>Index on <code class="cb">created_at DESC</code></li>
        <li>Direct <code class="cb">sqlite3</code> C API — no ORM</li>
        <li>Migrations via <code class="cb">ALTER TABLE ADD COLUMN</code></li>
      </ul>
    </div>
    <div class="section b-mauve" style="--i:25">
      <div class="section-label c-mauve"><span class="dot bg-mauve"></span>QMD Docs</div>
      <ul class="node-list">
        <li>One <code class="cm">.md</code> file per entry</li>
        <li>Collection: <code class="cm">cbmanager</code></li>
        <li><code class="cm">qmd update</code> — keyword index (420ms debounce)</li>
        <li><code class="cm">qmd embed</code> — vector embeddings (10s debounce)</li>
        <li>Bootstrap: only writes missing docs on startup</li>
      </ul>
    </div>
  </div>

  <div class="callout section section--recessed" style="--i:26; border-left-color: var(--green);">
    <strong>Delete + Undo</strong> — Deleted entries are pushed onto a <code class="cg">deletedStack</code> with a 20-second TTL.
    During that window, <code class="cg">⌘Z</code> restores the entry at its original index, re-inserts into SQLite and QMD,
    and selects it in the list. Image files are held in <code class="cg">pendingImageDeletions</code> and only permanently deleted
    after the undo window expires. Expired snapshots are cleaned up during each 150ms poll tick.
  </div>

  <div class="callout section section--recessed" style="--i:27; border-left-color: var(--mauve);">
    <strong>Auto-Prune</strong> — Optional age-based pruning (configurable in settings, default: off / 90 days).
    Runs on launch if enabled. Deletes entries from SQLite, removes from in-memory array, cleans up image files and QMD documents.
  </div>
</div>

<!-- ========== 7. WINDOW SYSTEM ========== -->
<div id="s7" class="sec-head" style="--i:28"><span class="dot bg-lavender"></span><span class="c-lav">7 &mdash; Window &amp; Panel System</span></div>

<div class="diagram">
  <div class="section b-lav" style="--i:29">
    <div class="section-label c-lav"><span class="dot bg-lav"></span>Panel Hierarchy</div>
    <div class="inner-grid">
      <div class="inner-card" style="border-color: var(--lavender-dim);">
        <div class="title" style="color: var(--lavender);">FocusPanel</div>
        <div class="desc">
          Custom <code class="cl">NSPanel</code> subclass. Overrides <code class="cl">canBecomeKey</code> and
          <code class="cl">canBecomeMain</code> to return <code class="cl">true</code>.
          Provides <code class="cl">onEscape</code> and <code class="cl">onKeyDown</code> hooks.
          Used by both overlay and preview panels.
        </div>
      </div>
      <div class="inner-card" style="border-color: var(--blue-dim);">
        <div class="title" style="color: var(--blue);">Overlay Panel (980 × 620)</div>
        <div class="desc">
          Borderless, <code class="cb">.ultraThinMaterial</code> background.
          Level: <code class="cb">.statusBar</code>.
          Movable by background with snap-to-center alignment guides.
          Hosts <code class="cb">SearchOverlayView</code> via <code class="cb">NSHostingView</code>.
          <code class="cb">hidesOnDeactivate: true</code>.
        </div>
      </div>
      <div class="inner-card" style="border-color: var(--mauve-dim);">
        <div class="title" style="color: var(--mauve);">Preview Panel (1040 × 700)</div>
        <div class="desc">
          Titled + closable. Opens via <code class="cm">⌘Y</code> — <strong>hides overlay first</strong>, then shows preview.
          On close, re-shows overlay. Has its own key monitor for <code class="cm">⌘Y</code> and <code class="cm">Esc</code>.
        </div>
      </div>
      <div class="inner-card" style="border-color: var(--yellow-dim);">
        <div class="title" style="color: var(--yellow);">Settings Panel</div>
        <div class="desc">
          Standard <code class="cy">NSWindow</code> (titled, closable). Level: <code class="cy">.floating</code>.
          Hosts <code class="cy">SettingsView</code> (SwiftUI) for configuring AI titles model, auto-prune, etc.
        </div>
      </div>
    </div>
  </div>

  <div class="section b-red" style="--i:30">
    <div class="section-label c-red"><span class="dot bg-red"></span>Keyboard Monitor Architecture</div>
    <p style="font-size: 13px; color: var(--text-dim); line-height: 1.7; margin-bottom: 12px;">
      Three independent keyboard monitor scopes, carefully managed to avoid conflicts:
    </p>
    <div class="inner-grid-3">
      <div class="inner-card" style="border-color: var(--red-dim);">
        <div class="title" style="color: var(--red);">Global Hotkey</div>
        <div class="desc"><code class="cr">Carbon EventHotKey</code> — system-wide, always active. Triggers overlay toggle. User-configurable (<code class="cr">⌘⇧V</code> default).</div>
      </div>
      <div class="inner-card" style="border-color: var(--red-dim);">
        <div class="title" style="color: var(--red);">Overlay Monitor</div>
        <div class="desc"><code class="cr">NSEvent.addLocalMonitor</code> — installed when overlay is visible, removed on hide. Handles ↑↓ navigation, Return, ⌘D/Z/Y/,.</div>
      </div>
      <div class="inner-card" style="border-color: var(--red-dim);">
        <div class="title" style="color: var(--red);">Preview Monitor</div>
        <div class="desc"><code class="cr">NSEvent.addLocalMonitor</code> — installed when preview is visible. Handles ⌘Y and Esc only. <code class="cr">FocusPanel.onKeyDown</code> as fallback.</div>
      </div>
    </div>
  </div>

  <div class="section b-teal" style="--i:31">
    <div class="section-label c-teal"><span class="dot bg-teal"></span>Alignment Guides</div>
    <p style="font-size: 13px; color: var(--text-dim); line-height: 1.7;">
      <code class="ct">AlignmentGuidesController</code> shows center crosshairs when the overlay is dragged near the screen center (±12px snap threshold).
      Guides appear during mouse drag and hide on mouse-up (tracked via a local mouse-up monitor).
      Panel position snaps programmatically when within threshold, using an <code class="ct">isProgrammaticMove</code> flag to prevent re-entrant <code class="ct">windowDidMove</code> calls.
    </p>
  </div>
</div>

<!-- ========== 8. KEY DECISIONS ========== -->
<div id="s8" class="sec-head" style="--i:32"><span class="dot bg-peach"></span><span class="c-peach">8 &mdash; Key Design Decisions</span></div>

<div class="diagram">
  <div class="section b-peach" style="--i:33">
    <div class="section-label c-peach"><span class="dot bg-peach"></span>Why These Choices?</div>
    <div class="inner-grid">
      <div class="inner-card" style="border-color: var(--peach-dim);">
        <div class="title" style="color: var(--peach);">Timer Polling (not NotificationCenter)</div>
        <div class="desc">macOS has no public clipboard-change notification. The 150ms poll on <code class="cp">NSPasteboard.changeCount</code> is the standard pattern. Lightweight — just an integer comparison. Runs on <code class="cp">RunLoop.main (.common)</code> so it works even during menu tracking.</div>
      </div>
      <div class="inner-card" style="border-color: var(--peach-dim);">
        <div class="title" style="color: var(--peach);">Raw sqlite3 C API (no ORM)</div>
        <div class="desc">Zero external dependencies. The schema is simple (one table, one index). Migrations are just <code class="cp">ALTER TABLE ADD COLUMN</code>. Prepared statements avoid SQL injection. No SwiftData/CoreData overhead for a single-table dataset.</div>
      </div>
      <div class="inner-card" style="border-color: var(--peach-dim);">
        <div class="title" style="color: var(--peach);">Carbon Hotkeys (not MASShortcut)</div>
        <div class="desc"><code class="cp">RegisterEventHotKey</code> is the only reliable way to register system-wide hotkeys on macOS without Accessibility permissions. Works even when the app is not frontmost. User-customizable via <code class="cp">ShortcutRecorderPanelController</code>.</div>
      </div>
      <div class="inner-card" style="border-color: var(--peach-dim);">
        <div class="title" style="color: var(--peach);">NSPanel over NSWindow</div>
        <div class="desc">Panels can float above regular windows, support <code class="cp">hidesOnDeactivate</code>, and participate in the key window cycle differently. Critical for a Spotlight-style overlay that should dismiss when you click elsewhere.</div>
      </div>
      <div class="inner-card" style="border-color: var(--peach-dim);">
        <div class="title" style="color: var(--peach);">QMD as Optional Augmentation</div>
        <div class="desc">QMD is <strong>never blocking</strong>. Fuzzy search works without it. QMD results arrive async and merge in. The <code class="cp">isQMDAvailable</code> flag gates all QMD code paths. <code class="cp">QMDSearchEngine</code> resolves the <code class="cp">qmd</code> binary from the user's login shell PATH (GUI apps inherit a minimal PATH).</div>
      </div>
      <div class="inner-card" style="border-color: var(--peach-dim);">
        <div class="title" style="color: var(--peach);">CGEvent for Synthetic Paste</div>
        <div class="desc">After copying the selected entry to the pasteboard and reactivating the target app, a synthetic <code class="cp">⌘V</code> is injected via <code class="cp">CGEvent</code>. Requires Accessibility permission. The 80+120ms delays are tuned to give macOS time to complete the app switch.</div>
      </div>
    </div>
  </div>

  <div class="callout section section--recessed" style="--i:34; border-left-color: var(--red);">
    <strong>Fragile areas</strong> — (1) Keyboard monitors across overlay + preview must not conflict — each installs/removes its own monitor on show/hide.
    (2) Focus restoration is order-sensitive — changes to hide/show sequencing can break app handoff.
    (3) QMD processes are cancellable via <code class="cr">ProcessHolder</code> with <code class="cr">withTaskCancellationHandler</code> to avoid zombie processes on rapid query changes.
  </div>
</div>

<!-- ========== 9. FILE MAP ========== -->
<div id="s9" class="sec-head" style="--i:35"><span class="dot bg-teal"></span><span class="c-teal">9 &mdash; File Map</span></div>

<details class="collapsible" style="--i:36">
  <summary>Sources/CBManager — 19 Swift files</summary>
  <div class="collapsible__body">
    <ul class="node-list">
      <li><code class="cm">AppDelegate.swift</code> — NSApplicationDelegate entry point</li>
      <li><code class="cm">AppModel.swift</code> — App coordinator: owns store, hotkey, status bar, overlay, settings</li>
      <li><code class="cm">StatusBarController.swift</code> — Menu bar icon, left-click toggle, right-click context menu</li>
      <li><code class="cb">OverlayPanelController.swift</code> — Overlay panel lifecycle, focus restore, paste flow, snap guides</li>
      <li><code class="cb">EntryPreviewPanelController.swift</code> — In-app preview panel (⌘Y toggle)</li>
      <li><code class="cb">FocusPanel.swift</code> — NSPanel subclass with key/escape overrides</li>
      <li><code class="cb">AlignmentGuidesController.swift</code> — Center snap alignment guides during drag</li>
      <li><code class="cb">Views/SearchOverlayView.swift</code> — Main SwiftUI overlay: search bar, grouped list, preview pane, keyboard handling</li>
      <li><code class="cb">Views/SettingsView.swift</code> — SwiftUI settings form</li>
      <li><code class="cg">ClipboardStore.swift</code> — Clipboard capture, filtering, delete/undo, OCR/AI title coordination</li>
      <li><code class="cg">ClipboardSearch.swift</code> — Pure functions: fuzzy scoring, QMD threshold logic, rank/merge</li>
      <li><code class="cg">ClipboardDatabase.swift</code> — SQLite CRUD, schema creation, migrations</li>
      <li><code class="cg">QMDSearchEngine.swift</code> — Actor: write markdown docs, run qmd keyword/semantic/update/embed</li>
      <li><code class="cy">ImageTextRecognizer.swift</code> — Vision OCR (VNRecognizeTextRequest)</li>
      <li><code class="cy">ImageTitleGenerator.swift</code> — pi CLI invocation for AI image descriptions</li>
      <li><code class="cy">ThumbnailCache.swift</code> — ImageIO-based thumbnail generation + NSCache</li>
      <li><code class="cr">GlobalHotKey.swift</code> — Carbon RegisterEventHotKey wrapper</li>
      <li><code class="cr">HotKeyShortcut.swift</code> — Codable shortcut model + modifier symbol rendering</li>
      <li><code class="cl">SettingsPanelController.swift</code> — NSWindow host for settings + ShortcutRecorderPanelController</li>
      <li><code class="cl">ShortcutRecorderPanelController.swift</code> — Modal shortcut capture panel</li>
    </ul>
  </div>
</details>

<details class="collapsible" style="--i:37; margin-top: 12px;">
  <summary>User Data Locations</summary>
  <div class="collapsible__body">
    <ul class="node-list">
      <li><code class="cb">~/Library/Application Support/CBManager/clipboard.sqlite</code> — SQLite database</li>
      <li><code class="cy">~/Library/Application Support/CBManager/images/</code> — PNG image files (one per image entry)</li>
      <li><code class="cm">~/Library/Application Support/CBManager/qmd-docs/</code> — QMD markdown documents (one per entry)</li>
      <li><code class="cl">~/Library/Application Support/CBManager/settings.json</code> — Global shortcut + app settings</li>
    </ul>
  </div>
</details>

<!-- ========== 10. DEPENDENCIES ========== -->
<div id="s10" class="sec-head" style="--i:38"><span class="dot bg-flamingo"></span><span class="c-flam">10 &mdash; Dependencies &amp; Frameworks</span></div>

<div class="diagram">
  <div class="three-col">
    <div class="section b-flam" style="--i:39">
      <div class="section-label c-flam"><span class="dot bg-flam"></span>System Frameworks</div>
      <ul class="node-list">
        <li><code class="cr">AppKit</code> — NSPanel, NSStatusBar, NSPasteboard, NSWorkspace</li>
        <li><code class="cr">SwiftUI</code> — All views (overlay, preview, settings)</li>
        <li><code class="cr">Carbon</code> — RegisterEventHotKey, key codes</li>
        <li><code class="cr">Vision</code> — VNRecognizeTextRequest (OCR)</li>
        <li><code class="cr">ImageIO</code> — CGImageSource thumbnails + dimensions</li>
        <li><code class="cr">SQLite3</code> — Direct C API for persistence</li>
        <li><code class="cr">CoreGraphics</code> — CGEvent for synthetic ⌘V</li>
      </ul>
    </div>
    <div class="section b-teal" style="--i:40">
      <div class="section-label c-teal"><span class="dot bg-teal"></span>External CLIs (Optional)</div>
      <ul class="node-list">
        <li><code class="ct">qmd</code> — Keyword search, vector search, indexing, embedding. Detected at runtime via shell PATH resolution.</li>
        <li><code class="ct">pi</code> — AI image title generation. Also detected at runtime. Configurable model.</li>
      </ul>
    </div>
    <div class="section b-green" style="--i:41">
      <div class="section-label c-green"><span class="dot bg-green"></span>Swift Package Deps</div>
      <p style="font-size: 24px; font-weight: 700; text-align: center; color: var(--green); padding: 20px 0;">None</p>
      <p style="font-size: 12px; color: var(--text-dim); text-align: center; line-height: 1.6;">
        Zero external Swift packages. Everything is built on Apple system frameworks. This keeps the binary small, builds fast, and avoids dependency churn.
      </p>
    </div>
  </div>

  <div class="callout section section--recessed" style="--i:42; border-left-color: var(--teal);">
    <strong>PATH resolution</strong> — Both <code class="ct">QMDSearchEngine</code> and <code class="ct">ImageTitleGenerator</code> resolve binary paths
    by spawning a login shell (<code class="ct">$SHELL -lc "echo $PATH"</code>) on first use. This is necessary because GUI apps on macOS inherit a
    minimal PATH (<code class="ct">/usr/bin:/bin:/usr/sbin:/sbin</code>) that typically doesn't include Homebrew or user-installed binaries.
    The resolved path is cached for the lifetime of the app.
  </div>
</div>

</div><!-- /main -->
</div><!-- /wrap -->

<!-- ============ MERMAID + ZOOM JS ============ -->
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

  const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  mermaid.initialize({
    startOnLoad: true,
    theme: 'base',
    look: 'classic',
    themeVariables: {
      primaryColor: isDark ? '#24243e' : '#e8e3ff',
      primaryBorderColor: isDark ? '#cba6f7' : '#8839ef',
      primaryTextColor: isDark ? '#cdd6f4' : '#1e1e2e',
      secondaryColor: isDark ? '#1e2e1e' : '#e8ffe8',
      secondaryBorderColor: isDark ? '#a6e3a1' : '#40a02b',
      secondaryTextColor: isDark ? '#cdd6f4' : '#1e1e2e',
      tertiaryColor: isDark ? '#2e2418' : '#fff3e0',
      tertiaryBorderColor: isDark ? '#fab387' : '#fe640b',
      tertiaryTextColor: isDark ? '#cdd6f4' : '#1e1e2e',
      lineColor: isDark ? '#6c7086' : '#9ca3af',
      fontSize: '14px',
      fontFamily: "'Sora', system-ui, sans-serif",
      noteBkgColor: isDark ? '#1e1e2e' : '#fefce8',
      noteTextColor: isDark ? '#cdd6f4' : '#1e1e2e',
      noteBorderColor: isDark ? '#f9e2af' : '#df8e1d',
      actorBkg: isDark ? '#24243e' : '#e8e3ff',
      actorBorder: isDark ? '#89b4fa' : '#1e66f5',
      actorTextColor: isDark ? '#cdd6f4' : '#1e1e2e',
      activationBkgColor: isDark ? '#313244' : '#ddd6fe',
      activationBorderColor: isDark ? '#89b4fa' : '#1e66f5',
      signalColor: isDark ? '#cdd6f4' : '#1e1e2e',
      signalTextColor: isDark ? '#cdd6f4' : '#1e1e2e',
    }
  });
</script>

<script>
// Zoom controls
function updateZoomState(wrap) {
  var target = wrap.querySelector('.mermaid');
  var zoom = parseFloat(target.dataset.zoom || '1');
  wrap.classList.toggle('is-zoomed', zoom > 1);
}
function zoomDiagram(btn, factor) {
  var wrap = btn.closest('.mermaid-wrap');
  var target = wrap.querySelector('.mermaid');
  var current = parseFloat(target.dataset.zoom || '1');
  var next = Math.min(Math.max(current * factor, 0.3), 5);
  target.dataset.zoom = next;
  target.style.transform = 'scale(' + next + ')';
  updateZoomState(wrap);
}
function resetZoom(btn) {
  var wrap = btn.closest('.mermaid-wrap');
  var target = wrap.querySelector('.mermaid');
  target.dataset.zoom = '1';
  target.style.transform = 'scale(1)';
  updateZoomState(wrap);
}

document.querySelectorAll('.mermaid-wrap').forEach(function(wrap) {
  wrap.addEventListener('wheel', function(e) {
    if (!e.ctrlKey && !e.metaKey) return;
    e.preventDefault();
    var target = wrap.querySelector('.mermaid');
    var current = parseFloat(target.dataset.zoom || '1');
    var factor = e.deltaY < 0 ? 1.1 : 0.9;
    var next = Math.min(Math.max(current * factor, 0.3), 5);
    target.dataset.zoom = next;
    target.style.transform = 'scale(' + next + ')';
    updateZoomState(wrap);
  }, { passive: false });

  var startX, startY, scrollL, scrollT;
  wrap.addEventListener('mousedown', function(e) {
    if (e.target.closest('.zoom-controls')) return;
    var target = wrap.querySelector('.mermaid');
    if (parseFloat(target.dataset.zoom || '1') <= 1) return;
    wrap.classList.add('is-panning');
    startX = e.clientX; startY = e.clientY;
    scrollL = wrap.scrollLeft; scrollT = wrap.scrollTop;
  });
  window.addEventListener('mousemove', function(e) {
    if (!wrap.classList.contains('is-panning')) return;
    wrap.scrollLeft = scrollL - (e.clientX - startX);
    wrap.scrollTop = scrollT - (e.clientY - startY);
  });
  window.addEventListener('mouseup', function() { wrap.classList.remove('is-panning'); });
});

// Scroll-spy TOC
(function() {
  const toc = document.getElementById('toc');
  const links = toc.querySelectorAll('a');
  const sections = [];
  links.forEach(link => {
    const id = link.getAttribute('href').slice(1);
    const el = document.getElementById(id);
    if (el) sections.push({ id, el, link });
  });
  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        links.forEach(l => l.classList.remove('active'));
        const match = sections.find(s => s.el === entry.target);
        if (match) {
          match.link.classList.add('active');
          if (window.innerWidth <= 1000) {
            match.link.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
          }
        }
      }
    });
  }, { rootMargin: '-10% 0px -80% 0px' });
  sections.forEach(s => observer.observe(s.el));
  links.forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      const id = link.getAttribute('href').slice(1);
      const el = document.getElementById(id);
      if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'start' }); history.replaceState(null, '', '#' + id); }
    });
  });
})();
</script>

</body>
</html>
